<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Daria Setevinets x TwinPlyos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Предзагрузка ресурсов -->
    <link rel="preload" href="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-1.png" as="image">
    <link rel="preload" href="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-2.png" as="image">
    <link rel="preload" href="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-3.png" as="image">
    <link rel="preload" href="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-4.png" as="image">
    <link rel="preload" href="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-5.png" as="image">
    <link rel="preload" href="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-6.png" as="image">
    <link rel="preload" href="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-7.png" as="image">
    <link rel="preload" href="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-8.png" as="image">

    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <script>
        AFRAME.registerComponent('card-align', {
            init: function() {
                this.drawingSize = {
                    width: 0.105,
                    height: 0.072
                };
                this.offset = new THREE.Vector3(-0.0525, 0.036, 0.01);
            },
            tick: function() {
                if (!this.el.object3D.visible) return;
                const marker = this.el.parentEl.object3D;
                const position = new THREE.Vector3();
                position.setFromMatrixPosition(marker.matrixWorld);
                position.add(this.offset);
                this.el.object3D.position.copy(position);
                this.el.object3D.quaternion.setFromRotationMatrix(marker.matrixWorld);
                this.el.object3D.rotation.x = -Math.PI/2;
            }
        });
    </script>

    <style>
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: rgba(255,255,255,0.9);
            text-align: center;
            font-family: Arial;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .card-info {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            font-size: 18px;
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        Наведите камеру на открытку<br>
        <small>Держите устройство ровно</small>
    </div>
    <div class="card-info" id="cardInfo"></div>

    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; 
              debugUIEnabled: false;
              detectionMode: mono_and_matrix;
              matrixCodeType: 3x3;
              sourceWidth: 1280;
              sourceHeight: 720;"
        renderer="logarithmicDepthBuffer: true;"
    >
        <a-assets>
            <img id="drawing1" src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-1.png" crossorigin="anonymous">
            <img id="drawing2" src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-2.png" crossorigin="anonymous">
            <img id="drawing3" src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-3.png" crossorigin="anonymous">
            <img id="drawing4" src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-4.png" crossorigin="anonymous">
            <img id="drawing5" src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-5.png" crossorigin="anonymous">
            <img id="drawing6" src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-6.png" crossorigin="anonymous">
            <img id="drawing7" src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-7.png" crossorigin="anonymous">
            <img id="drawing8" src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-8.png" crossorigin="anonymous">
        </a-assets>

        <a-entity geometry="primitive: plane; width: 0.105; height: 0.072" material="color: red; opacity: 0.3; side: double" position="-0.0215 0.069 0.001" visible="false" class="debug-frame"></a-entity>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const cardInfo = document.getElementById('cardInfo');
        const loading = document.getElementById('loading');

        const images = document.querySelectorAll('a-assets img[id^="drawing"]');
        let loadedCount = 0;

        images.forEach(img => {
            img.onload = () => {
                loadedCount++;
                if (loadedCount === images.length) {
                    loading.classList.add('hidden');
                }
            };
            img.onerror = () => console.error(`Ошибка загрузки: ${img.src}`);
        });

        scene.addEventListener('markerFound', function(e) {
            const name = e.target.getAttribute('data-name');
            if (name) {
                cardInfo.textContent = name;
                document.querySelector('.debug-frame').setAttribute('visible', 'true');
            }
        });

        scene.addEventListener('markerFound', (e) => {
            const marker = e.target;
            console.log('Маркер найден:', marker.getAttribute('data-name'));
            console.log('Дочерние элементы:', marker.children.length);
            const img = marker.querySelector('a-image');
            if (img) {
                console.log('Изображение:', {
                    src: img.getAttribute('src'),
                    visible: img.object3D.visible,
                    position: img.object3D.position,
                    rotation: img.object3D.rotation
                });
            }
        });

        if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
            scene.setAttribute('arjs', {
                sourceWidth: window.innerWidth,
                sourceHeight: window.innerHeight,
                trackingMethod: 'best'
            });
        }
    </script>
</body>
</html>
