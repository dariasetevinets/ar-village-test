<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Сетевинец Дарья х TwinПлес</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    .status {
      position: fixed; bottom: 20px; left: 0; right: 0;
      text-align: center; color: #fff; font-family: system-ui, Arial, sans-serif;
      background: rgba(0,0,0,.5); padding: 10px; z-index: 100;
    }
    .title {
      position: fixed; top: 12px; left: 0; right: 0;
      text-align: center; font: 600 18px/1.2 system-ui, Arial, sans-serif;
      color: #fff; z-index: 120; padding: 10px 14px; pointer-events: none;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
      transition: opacity .25s ease, transform .25s ease;
    }
    .title.hidden { opacity: 0; transform: translateY(-6px); }
    @media (max-width: 480px) { .title { font-size: 16px; } }
      .title.hidden { opacity: 0; transform: translateY(-6px); }
    @media (max-width: 480px) { .title { font-size: 16px; } }

    /* Work name (shows after marker recognition) */
    .work-name {
      position: fixed; top: 52px; left: 0; right: 0;
      text-align: center; font: 700 18px/1.2 system-ui, Arial, sans-serif;
      color: #fff; z-index: 121; padding: 6px 10px; pointer-events: none;
      text-shadow: 0 2px 12px rgba(0,0,0,.6);
      transition: opacity .25s ease, transform .25s ease;
    }
    .work-name.hidden { opacity: 0; transform: translateY(-6px); }

    /* About button & panel */
    .about-btn {
    position: fixed;
    top: 16px;
    left: 16px;
    bottom: auto;
    z-index: 130;
    background: rgba(0,0,0,.75);
    color: #fff;
    border: 0;
    border-radius: 999px;
    padding: 12px 14px;
    font: 500 14px/1 system-ui, Arial, Helvetica, sans-serif;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,.3);
    }
    .about-btn:active { transform: translateY(1px); }

    .about-panel {
    position: fixed;
    top: 64px;
    left: 16px;
    right: auto;
    bottom: auto;
    width: min(90vw, 320px);
    background: rgba(0,0,0,.85);
    color: #fff;
    z-index: 140;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.35);
    backdrop-filter: blur(6px);
    }
    @media (orientation: landscape) {
      .about-btn {
        top: 12px;
        left: 12px;
      }
      .about-panel {
        top: 56px;
        left: 12px;
      }
    }
    .about-panel.hidden { display: none; }
    .about-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .about-close { background: none; border: 0; color: #fff; font-size: 20px; line-height: 1; cursor: pointer; padding: 4px; }
    .about-content { font: 14px/1.45 system-ui, Arial, Helvetica, sans-serif; opacity: .95; }
    .about-content a { color: #a5d8ff; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="status">Наведите камеру на маркер</div>
  <div class="title" id="title">Сетевинец Дарья х TwinПлес</div>
  <div class="work-name hidden" id="workName">index_1, 2024</div>

  <button class="about-btn" id="aboutBtn" type="button">about</button>
  <div class="about-panel hidden" id="aboutPanel" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
    <div class="about-header">
      <strong><span id="aboutWorkName">index_1, 2024</span></strong></p>
      <button id="aboutClose" class="about-close" aria-label="Закрыть">×</button>
    </div>
    <div class="about-content">
      <p><strong>медиум</strong> рисунок</p>
      <p><strong>описание</strong> размер, материалы, пипипи</p>
    </div>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; cameraParametersUrl: https://raw.githack.com/AR-js-org/AR.js/master/data/data/camera_para.dat"
    renderer="logarithmicDepthBuffer: true;"
  >
    <a-assets timeout="30000">
      <img id="main-texture1" crossorigin="anonymous"
           src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-1.png" />
      <img id="main-texture2" crossorigin="anonymous"
        src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-2.png" />
      <img id="main-texture3" crossorigin="anonymous" 
        src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-3.png" />
      <img id="main-texture4" crossorigin="anonymous" 
        src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-4.png" />
      <img id="main-texture5" crossorigin="anonymous"
        src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-5.png" />
      <img id="main-texture6" crossorigin="anonymous" 
        src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-6.png" />
      <img id="main-texture7" crossorigin="anonymous" 
        src="https://dariasetevinets.github.io/ar-village-test/assets/drawings/setevinets_index-7.png" />


      <script id="vertexShader" type="x-shader/x-vertex">
        varying vec2 vUv;
        uniform float intensity;
        void main () {
          vUv = uv;
          float waveX = sin(position.x * 4.0) * 0.02 * intensity;
          float waveY = cos(position.y * 3.0) * 0.02 * intensity;
          vec3 newPosition = position + vec3(waveX, waveY, 0.0);
          gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
        }
      </script>

      <script id="jitterShader" type="x-shader/x-fragment">
        #ifdef GL_FRAGMENT_PRECISION_HIGH
          precision highp float;
        #else
          precision mediump float;
        #endif
        uniform sampler2D map;
        uniform float time;
        uniform float intensity;
        varying vec2 vUv;
        void main () {
          // Амплитуда — маленькая, управляется intensity
          float baseAmp = 0.015 * intensity;
          float jitter = sin(time * 0.05) * baseAmp;

          vec2 uv = vUv + vec2(
            jitter * sin(time * 3.0 + vUv.y * 15.0),
            jitter * cos(time * 2.5 + vUv.x * 12.0)
          );

          // Кламп, чтобы не упираться в прозрачные/одноцветные края
          uv = clamp(uv, vec2(0.001), vec2(0.999));

          vec4 color = texture2D(map, uv);
          // Легкий RGB-split для видимости эффекта
          color.r = texture2D(map, clamp(uv + vec2( 0.01 * intensity, 0.0), vec2(0.001), vec2(0.999))).r;
          color.g = texture2D(map, clamp(uv + vec2( 0.0, 0.01 * intensity), vec2(0.001), vec2(0.999))).g;
          color.b = texture2D(map, clamp(uv + vec2(-0.008 * intensity, -0.008 * intensity), vec2(0.001), vec2(0.999))).b;

          // Небольшая пульсация альфы
          color.a *= 0.85 + 0.15 * sin(time * 8.0);
          gl_FragColor = color;
        }
      </script>
    </a-assets>

    <script>
      AFRAME.registerComponent('jitter-effect', {
        schema: {
          speed: { type: 'number', default: 0.5 },
          intensity: { type: 'number', default: 0.5 }
        },

        init: function () {
          this.material = null;
          this._time = 0;

          // Готовим текстуру из <img id="main-texture">, уже загруженного в <a-assets>
          const img = document.getElementById(this.data.texId);
          if (!img || !img.complete) {
            // Ждём ассета, если что
            img?.addEventListener('load', () => this._buildMaterial(img));
          } else {
            this._buildMaterial(img);
          }

          // Применять материал, когда появится mesh
          this.el.addEventListener('loaded', () => this._applyWhenReady());
          this.el.addEventListener('object3dset', (e) => {
            if (e.detail && e.detail.type === 'mesh') this._applyWhenReady();
          });
        },

        _buildMaterial: function (imgEl) {
          // Почему так: используем уже загруженный элемент из <a-assets> → меньше CORS/таинта
          const texture = new THREE.Texture(imgEl);
          texture.needsUpdate = true;
          texture.colorSpace = THREE.SRGBColorSpace;
          texture.minFilter = THREE.LinearFilter; // NPOT-safe
          texture.magFilter = THREE.LinearFilter;
          texture.wrapS = THREE.ClampToEdgeWrapping;
          texture.wrapT = THREE.ClampToEdgeWrapping;

          this.material = new THREE.ShaderMaterial({
            uniforms: {
              map: { value: texture },
              time: { value: 0 },
              intensity: { value: this.data.intensity }
            },
            vertexShader: document.getElementById('vertexShader').textContent,
            fragmentShader: document.getElementById('jitterShader').textContent,
            transparent: true,
            depthWrite: false, // важно для корректного альфа-бленда в AR
            side: THREE.DoubleSide // плоскость видна с обеих сторон
          });
        },

        _applyWhenReady: function () {
          const mesh = this.el.getObject3D('mesh');
          if (!mesh || !this.material) return;
          mesh.traverse((obj) => {
            if (obj.isMesh) {
              obj.material = this.material;
              obj.material.needsUpdate = true; // важно при замене материала
            }
          });
          // console.log('Jitter material applied');
        },

        tick: function (time, dt) {
          if (!this.material) return;
          // A-Frame даёт time в мс. Делаем накопительный счётчик (устойчивее, чем mod)
          this._time += (dt || 0) * 0.001 * this.data.speed;
          this.material.uniforms.time.value = this._time;
        },

        update: function (oldData) {
          if (!this.material) return;
          if (oldData.intensity !== this.data.intensity) {
            this.material.uniforms.intensity.value = this.data.intensity;
          }
        },

        remove: function () {
          if (this.material) {
            const tex = this.material.uniforms.map?.value;
            this.material.dispose();
            if (tex && tex.dispose) tex.dispose();
            this.material = null;
          }
        }
      });
    </script>

    <a-marker id="marker1"
      type="pattern"
      url="https://dariasetevinets.github.io/ar-village-test/assets/patterns/sdxtp-1.patt"
      size="0.05"
      emitevents="true"
      data-work-name="index_1 (опушка), 2024"
      data-author="сетевинец дарья x twinплес"
      data-medium="настолбный рисунок, древесный уголь"
      data-coordinates="57.425712, 41.474726"
    >
      <a-entity id="smoothed1"
        smoothed-controls="source: #marker1; lerp-position: 0.6; lerp-rotation: 0.3; lerp-scale: 0.6">
        <a-entity id="art1"
          geometry="primitive: plane; width: 5.5; height: 3.5"
          position="-2.0 0 -1.2"
          rotation="-90 0 0"
          jitter-effect="speed: 0.5; intensity: 0.5; texId: main-texture1"
          //animation__intensity="property: jitter-effect.intensity; to: 12; dur: 2000; loop: true; dir: alternate; easing: easeInOutSine"
          ></a-entity>
        </a-entity>
    </a-marker>
    
    <a-marker id="marker2" 
      type="pattern" 
      url="https://dariasetevinets.github.io/ar-village-test/assets/patterns/sdxtp-2.patt"
      size="0.05"
      emitevents="true"
      data-work-name="index_2 (дом_хозяйки), 2024"
      data-author="сетевинец дарья x twinплес"
      data-medium="настолбный рисунок, древесный уголь"
      data-coordinates="57.426346, 41.473834"
    >
      <a-entity id="smoothed2"
        smoothed-controls="source: #marker2; lerp-position: 0.6; lerp-rotation: 0.3; lerp-scale: 0.6">
        <a-entity id="art2"
          geometry="primitive: plane; width: 8.2; height: 5.92"
          position="-2.0 0 -1.0" 
          rotation="-90 0 0"
          jitter-effect="speed: 4.0; intensity: 1.0; texId: main-texture2"
        ></a-entity>
      </a-entity>
    </a-marker>
    
    <a-marker id="marker3"
      type="pattern" 
      url="https://dariasetevinets.github.io/ar-village-test/assets/patterns/sdxtp-3.patt" 
      size="0.05"
      emitevents="true"
      data-work-name="index_3 (люсики), 2024"
      data-author="сетевинец дарья x twinплес"
      data-medium="настолбный рисунок, древесный уголь"
      data-coordinates="57.425667, 41.473106"
    >
      <a-entity id="smoothed3"
        smoothed-controls="source: #marker3; lerp-position: 0.6; lerp-rotation: 0.3; lerp-scale: 0.6">
        <a-entity id="art3" 
          geometry="primitive: plane; width: 8.2; height: 5.92"
          position="-2.0 0 -1.0" 
          rotation="-90 0 0"
          jitter-effect="speed: 4.0; intensity: 1.0; texId: main-texture3" 
        ></a-entity>
      </a-entity>
    </a-marker>
    
    <a-marker id="marker4"
      type="pattern"
      url="https://dariasetevinets.github.io/ar-village-test/assets/patterns/sdxtp-4.patt" 
      size="0.05"
      emitevents="true"
      data-work-name="index_4 (пустой_колодец), 2024"
      data-author="сетевинец дарья x twinплес"
      data-medium="настолбный рисунок, древесный уголь"
      data-coordinates="57.426030, 41.473514"
    >
      <a-entity id="smoothed4"
        smoothed-controls="source: #marker4; lerp-position: 0.6; lerp-rotation: 0.3; lerp-scale: 0.6">
        <a-entity id="art4"
          geometry="primitive: plane; width: 8.2; height: 5.92"
          position="-2.0 0 -1.0" 
          rotation="-90 0 0"
          jitter-effect="speed: 4.0; intensity: 1.0; texId: main-texture4"
        ></a-entity>
      </a-entity>
    </a-marker>
    
    <a-marker id="marker5"
      type="pattern" 
      url="https://dariasetevinets.github.io/ar-village-test/assets/patterns/sdxtp-5.patt" 
      size="0.05"
      emitevents="true"
      data-work-name="index_5 (ведьмин_дом), 2024"
      data-author="сетевинец дарья x twinплес"
      data-medium="настолбный рисунок, древесный уголь"
      data-coordinates="57.426640, 41.474156"
    >
      <a-entity id="smoothed5"
        smoothed-controls="source: #marker5; lerp-position: 0.6; lerp-rotation: 0.3; lerp-scale: 0.6">
        <a-entity id="art5"
          geometry="primitive: plane; width: 8.2; height: 5.92"
          position="-2.0 0 -1.0" 
          rotation="-90 0 0"
          jitter-effect="speed: 4.0; intensity: 1.0; texId: main-texture5"
        ></a-entity>
      </a-entity>
    </a-marker>
    
    <a-marker id="marker6"
      type="pattern" 
      url="https://dariasetevinets.github.io/ar-village-test/assets/patterns/sdxtp-6.patt" 
      size="0.05"
      emitevents="true"
      data-work-name="index_6 (к_к), 2024"
      data-author="сетевинец дарья x twinплес"
      data-medium="настолбный рисунок, древесный уголь"
      data-coordinates="57.425415, 41.472618"
    >
      <a-entity id="smoothed6"
        smoothed-controls="source: #marker6; lerp-position: 0.6; lerp-rotation: 0.3; lerp-scale: 0.6">
        <a-entity id="art6"
          geometry="primitive: plane; width: 8.2; height: 5.92"
          position="-2.0 0 -1.0" 
          rotation="-90 0 0"
          jitter-effect="speed: 4.0; intensity: 1.0; texId: main-texture6"
        ></a-entity>
      </a-entity>
    </a-marker>
    
    <a-marker id="marker7"
      type="pattern" 
      url="https://dariasetevinets.github.io/ar-village-test/assets/patterns/sdxtp-7.patt" 
      size="0.05"
      emitevents="true"
      data-work-name="index_7 (землянка), 2024"
      data-author="сетевинец дарья x twinплес"
      data-medium="настолбный рисунок, древесный уголь"
      data-coordinates="57.425693, 41.473102"
    >
      <a-entity id="smoothed7"
        smoothed-controls="source: #marker7; lerp-position: 0.6; lerp-rotation: 0.3; lerp-scale: 0.6">
        <a-entity id="art7"
          geometry="primitive: plane; width: 8.2; height: 5.92"
          position="-2.0 0 -1.0" 
          rotation="-90 0 0"
          jitter-effect="speed: 4.0; intensity: 1.0; texId: main-texture7"
        ></a-entity>
      </a-entity>
    </a-marker>
    
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Статус теперь слушает события именно на a-marker
    const statusEl = document.querySelector('.status');
    const markerEl = document.getElementById('marker');
    const titleEl = document.getElementById('title');
    const workNameEl = document.getElementById('workName');

    const aboutBtn = document.getElementById('aboutBtn');
    const aboutPanel = document.getElementById('aboutPanel');
    const aboutClose = document.getElementById('aboutClose');
    const aboutWorkName = document.getElementById('aboutWorkName');

    function showWorkName() { workNameEl?.classList.remove('hidden'); }
    function hideWorkName() { workNameEl?.classList.add('hidden'); }

    function openAbout() { aboutPanel?.classList.remove('hidden'); }
    function updateAboutPanelPosition() {
      const isLandscape = window.matchMedia("(orientation: landscape)").matches;
      const aboutBtn = document.getElementById('aboutBtn');
      const aboutPanel = document.getElementById('aboutPanel');

      if (!aboutBtn || !aboutPanel) return;

      if (isLandscape) {
        aboutBtn.style.top = '12px';
        aboutBtn.style.left = '12px';
        aboutPanel.style.top = '56px';
        aboutPanel.style.left = '12px';
      } else {
        aboutBtn.style.top = '16px';
        aboutBtn.style.left = '16px';
        aboutPanel.style.top = '64px';
        aboutPanel.style.left = '16px';
      }
    }
    window.addEventListener('orientationchange', updateAboutPanelPosition);
    window.addEventListener('resize', updateAboutPanelPosition);
    window.addEventListener('load', updateAboutPanelPosition);
    function closeAbout() { aboutPanel?.classList.add('hidden'); }
    
    window.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('a-marker').forEach(marker => {
      marker.addEventListener('markerFound', () => {
        const name = marker.dataset.workName || '';
        const author = marker.dataset.author || '';
        const medium = marker.dataset.medium || '';
        const coordinates = marker.dataset.coordinates || '';
        
        document.getElementById('workName').textContent = name;
        document.getElementById('aboutWorkName').textContent = name;
        document.querySelector('.about-content').innerHTML = `
          <p><strong>nzvn</strong> ${name}</p>
          <p><strong>kt</strong> ${author}</p>
          <p><strong>md</strong> ${medium}</p>
          <p><strong>crdnts</strong> ${coordinates}</p>
        `;

        document.getElementById('workName')?.classList.remove('hidden');
        document.getElementById('title')?.classList.add('hidden');
        document.querySelector('.status').textContent = 'Маркер распознан';
      });

      marker.addEventListener('markerLost', () => {
        document.getElementById('workName')?.classList.add('hidden');
        document.getElementById('title')?.classList.remove('hidden');
        document.querySelector('.status').textContent = 'Наведите камеру на маркер';
        
        aboutBtn?.addEventListener('click', () => {
          const hidden = aboutPanel?.classList.contains('hidden');
          if (hidden) openAbout(); else closeAbout();
        });
        
        aboutClose?.addEventListener('click', closeAbout);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAbout(); });
        window.addEventListener('webglcontextlost', () => {
          statusEl.textContent = 'Ошибка графики. Перезагрузите страницу.';
        }, false);
  </script>
</body>
</html>
